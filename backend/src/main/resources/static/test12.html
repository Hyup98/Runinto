<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f2f2f2; padding: 20px; }
    h1 { color: #4CAF50; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 500px; }
    #chatBox { background: #fff; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 10px; }
    #chatBox div { margin-bottom: 5px; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
  </style>
</head>
<body>

<h1>âœ… WebSocket ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>

<input type="text" id="userId" placeholder="ìœ ì € ID (ìˆ«ì)">
<input type="text" id="chatroomId" placeholder="ì±„íŒ…ë°© ID (ìˆ«ì)">
<button onclick="connect()">ğŸ”Œ WebSocket ì—°ê²°</button>

<div id="chatBox"></div>

<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥">
<button onclick="sendMessage()">ğŸ“¨ ë©”ì‹œì§€ ì „ì†¡</button>

<section style="margin-top: 30px;">
  <h2>ğŸ“¥ ì´ë²¤íŠ¸ ì°¸ì—¬</h2>
  <input type="text" id="eventJoinUserId" placeholder="ìœ ì € ID">
  <input type="text" id="eventJoinEventId" placeholder="ì´ë²¤íŠ¸ ID">
  <button onclick="joinEvent()">ì´ë²¤íŠ¸ ì°¸ì—¬ ìš”ì²­</button>
  <div id="joinEventResult" style="margin-top: 10px; font-weight: bold;"></div>
</section>

<script>
  let socket = null;
  let currentUserId = null;
  let currentChatroomId = null;

  function connect() {
    const userIdInput = document.getElementById("userId").value;
    const chatroomIdInput = document.getElementById("chatroomId").value;

    if (!userIdInput) {
      alert("ìœ ì € IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    if (socket && socket.readyState !== WebSocket.CLOSED) {
      socket.close();
    }

    const wsUrl = `ws://localhost:8080/ws/chat?userId=${encodeURIComponent(userIdInput)}`;
    socket = new WebSocket(wsUrl);

    currentUserId = userIdInput;
    currentChatroomId = chatroomIdInput || null;

    document.getElementById("chatBox").innerHTML = "";

    socket.onopen = () => {
      console.log("ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ: " + wsUrl);
      document.getElementById("chatBox").innerHTML += `<div><em>ğŸ”Œ ${currentUserId}ë‹˜, WebSocket ì—°ê²° ì„±ê³µ! (ì±„íŒ…ë°©: ${currentChatroomId || 'ë¯¸ì§€ì •'})</em></div>`;
    };

    socket.onmessage = (event) => {
      const msg = event.data;
      const box = document.getElementById("chatBox");
      box.innerHTML += `<div>${msg}</div>`;
      box.scrollTop = box.scrollHeight;
    };

    socket.onerror = (error) => {
      console.error("ì›¹ì†Œì¼“ ì—ëŸ¬:", error);
      document.getElementById("chatBox").innerHTML += `<div><em>ğŸ”Œ ì›¹ì†Œì¼“ ì—ëŸ¬ ë°œìƒ!</em></div>`;
      alert("ì›¹ì†Œì¼“ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    };

    socket.onclose = (event) => {
      console.warn("ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œë¨. ì½”ë“œ: " + event.code + ", ì´ìœ : " + event.reason);
      document.getElementById("chatBox").innerHTML += `<div><em>ğŸ”Œ ì›¹ì†Œì¼“ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</em></div>`;
    };
  }

  function sendMessage() {
    const content = document.getElementById("messageInput").value;

    if (!socket || socket.readyState !== WebSocket.OPEN) {
      alert("WebSocket ì—°ê²°ì´ ì•„ì§ ì—´ë ¤ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
      return;
    }

    if (!currentUserId || !currentChatroomId) {
      alert("ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë ¤ë©´ ìœ ì € IDì™€ ì±„íŒ…ë°© IDê°€ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    if (!content) {
      alert("ì „ì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const payload = {
      senderId: Number(currentUserId),
      chatRoomId: Number(currentChatroomId),
      message: content
    };

    try {
      socket.send(JSON.stringify(payload));
      document.getElementById("messageInput").value = "";
    } catch (error) {
      console.error("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", error);
      alert("ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  function joinEvent() {
    const userId = document.getElementById("eventJoinUserId").value;
    const eventId = document.getElementById("eventJoinEventId").value;

    if (!userId || !eventId) {
      alert("ìœ ì € IDì™€ ì´ë²¤íŠ¸ IDë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    const payload = {
      userId: Number(userId)
    };

    fetch(`http://localhost:8080/events/${eventId}/participants`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
            .then(response => {
              if (!response.ok) {
                return response.text().then(text => { throw new Error(text || `ì„œë²„ ì˜¤ë¥˜: ${response.status}`) });
              }
              return response.text();
            })
            .then(msg => {
              document.getElementById("joinEventResult").innerText = "âœ… " + (msg || "ì°¸ì—¬ ìš”ì²­ ì„±ê³µ!");
            })
            .catch(err => {
              document.getElementById("joinEventResult").innerText = "âŒ " + err.message;
            });
  }
</script>

</body>
</html>
